; ============================================================
; 大豐計程車 - Asterisk Dialplan
; ============================================================
;
; 流程：來電 → 接聽 → 播放歡迎語 → 嗶聲 → 錄音（靜音自動結束） → 掛斷 → webhook
;
; 歡迎語音檔：/usr/share/asterisk/sounds/en/custom/taxi-greeting.wav
; 錄音存放：  /var/spool/asterisk/recording/{UNIQUEID}.wav
; Webhook：   /usr/local/bin/taxi-webhook.sh
;
; 部署方式：
;   sudo cp extensions_taxi.conf /etc/asterisk/extensions_taxi.conf
;   sudo asterisk -rx 'dialplan reload'
;
; 最後更新：2026-03-01
; ============================================================

[from-phone]

; === 通用來電處理（_X. 匹配任何數字分機） ===
exten => _X.,1,NoOp(=== 來電: ${CALLERID(num)} → ${EXTEN} ===)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Set(CALL_ID=${UNIQUEID})
 same => n,Set(CALLER_NUM=${CALLERID(num)})
 same => n,Set(REC_FILE=/var/spool/asterisk/recording/${CALL_ID}.wav)
 same => n,Playback(custom/taxi-greeting)     ; 播放歡迎語（不含 beep，錄音前播完）
 same => n,MixMonitor(${REC_FILE})            ; 開始錄音（greeting 之後才錄，STT 更乾淨）
 same => n,Playback(beep)                     ; 嗶聲提示開始說話
 same => n,WaitForSilence(3000,2,30)          ; 3秒靜音×2次=等開口+說完沉默，最長30秒
 same => n,StopMixMonitor()                   ; 確保錄音檔正確關閉
 same => n,Hangup()

; === s 擴展（HT813 FXO 來電可能用 s） ===
exten => s,1,NoOp(=== 來電(s): ${CALLERID(num)} ===)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Set(CALL_ID=${UNIQUEID})
 same => n,Set(CALLER_NUM=${CALLERID(num)})
 same => n,Set(REC_FILE=/var/spool/asterisk/recording/${CALL_ID}.wav)
 same => n,Playback(custom/taxi-greeting)
 same => n,MixMonitor(${REC_FILE})
 same => n,Playback(beep)
 same => n,WaitForSilence(3000,2,30)
 same => n,StopMixMonitor()
 same => n,Hangup()

; === 掛斷事件（通話結束後觸發 webhook） ===
; 不論是系統自動掛斷或客戶主動掛斷都會觸發
exten => h,1,NoOp(=== 通話結束: ${CALL_ID}, 來電: ${CALLER_NUM}, 時長: ${CDR(duration)}s ===)
 same => n,System(/usr/local/bin/taxi-webhook.sh ${CALL_ID} ${CALLER_NUM} ${CDR(duration)} ${REC_FILE})
